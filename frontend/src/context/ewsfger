import React, { createContext, useEffect, useState, Dispatch } from 'react'
import { ProductType, CartType } from '../types'
import { alert } from '../components';

interface Categories {
    whey: ProductType[],
    creatine: ProductType[],
    preWorkout: ProductType[],
    combo: ProductType[],
}


type GlobalState = {
    cart: CartType[];
    cartOpen: boolean;
    userOpen: boolean;
    addressOpen: boolean;
    setCartOpen: Dispatch<React.SetStateAction<boolean>>;
    setUserOpen: Dispatch<React.SetStateAction<boolean>>;
    setAddressOpen: Dispatch<React.SetStateAction<boolean>>;
    addProduct: (product: ProductType) => void;
    removeProduct: (product: CartType) => void;
    incrementAmount: (product: CartType, payload: number) => void;
    decrementAmount: (product: CartType, payload: number) => void;
    updateProductAmount: (product: CartType, payload: number) => void;
}

export const GlobalContext = createContext<GlobalState>({
    cart: [],
    cartOpen: false,
    userOpen: false,
    addressOpen: false,
    setCartOpen: () => { },
    setUserOpen: () => { },
    setAddressOpen: () => { },
    addProduct: () => { },
    removeProduct: () => { },
    incrementAmount: () => { },
    decrementAmount: () => { },
    updateProductAmount: () => { },
});

export default function GlobalContextProvider({ children }: { children: React.ReactNode }) {

    const [cartOpen, setCartOpen] = useState<boolean>(false)
    const [userOpen, setUserOpen] = useState<boolean>(false)
    const [addressOpen, setAddressOpen] = useState<boolean>(false)
    const [cart, setCart] = useState<CartType[]>([])

    useEffect(() => {
        document.body.style.overflow = cartOpen || userOpen || addressOpen ? 'hidden' : 'auto';

    }, [cartOpen, userOpen, addressOpen]);

    useEffect(() => {
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
            setCart(JSON.parse(savedCart));
        }
    }, []);
    const findInCart = (cart: CartType[], product: ProductType | CartType) => cart.find((detail) => detail._id === product._id && detail.updatedName === product.updatedName);
    const updateCart = (updatedCart: CartType[]) => {
        setCart(updatedCart);
        localStorage.setItem('cart', JSON.stringify(updatedCart));
    }

    const addProduct = (product: ProductType) => {
        const { _id, name, coverPhoto, flavor, price, sizeProduct, stock, promotion, category, updatedName } = product.toCart;
        const findProduct = findInCart(cart, product.toCart)
        const updatedCart = findProduct
            ? cart.map((e: CartType) => (e._id === _id && e.updatedName === updatedName ? { ...e, amount: e.amount + 1 } : e))
            : [...cart, { _id, name, amount: 1, coverPhoto, flavor, price, sizeProduct, stock, promotion, category, updatedName }];

        if (!findProduct) alert('Produto adicionado ao carrinho', { variant: "success" });

        updateCart(updatedCart)
    };

    const incrementAmount = (product: (CartType), payload: (number)) => {
        const { name, _id, updatedName, stock } = product
        const findProduct = findInCart(cart, product)

        if (!findProduct) {

            const updatedCart = [...cart, { ...product, amount: payload > stock ? stock : payload }];

            updateCart(updatedCart)
        } else {
            const updatedCart = cart.map((e) => e.updatedName === updatedName && e._id == _id && e.amount + payload <= e.stock ? { ...e, amount: e.amount + payload } : e)
            updateCart(updatedCart)
        }

    }
    const decrementAmount = (product: (CartType), payload: (number)) => {

        const { updatedName, _id } = product
        const updatedCart = cart.map((e) => e.updatedName === updatedName && e._id == _id && (e.amount - payload) >= 1 ? { ...e, amount: e.amount - payload } : e)
        updateCart(updatedCart)
    }

    const updateProductAmount = (product: (CartType), target: (number)) => {
        const { _id, updatedName } = product

        const updatedCart: CartType[] = cart.map((e: CartType): CartType => {
            if (e._id === _id && e.updatedName === updatedName) {
                if (target > e.stock) {
                    target = e.stock
                    return { ...e, amount: e.stock }
                } if (target < 1) {
                    target = 1
                    return { ...e, amount: 1 }
                } else {
                    return { ...e, amount: target }
                }
            } else return e
        })
        updateCart(updatedCart)

    }
    const removeProduct = (product: (CartType)) => {
        const findProduct = findInCart(cart, product) as CartType
        const filterCart = cart.filter((e) => e !== findProduct)

        updateCart(filterCart)
    };
    return <GlobalContext.Provider value={{
        cart, addressOpen, setAddressOpen, userOpen, setUserOpen, cartOpen, setCartOpen, addProduct,
        removeProduct, incrementAmount, decrementAmount, updateProductAmount
    }}>
        {children}
    </GlobalContext.Provider >
}